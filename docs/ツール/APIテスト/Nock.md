# Nock

## 概要

Nock は Node.js で HTTP リクエストをモックするためのライブラリである。`http/https` レイヤーをインターセプトし、外部 API への通信を実際に行わずにテストできる。ユニットテストや統合テストで外部依存を排除し、安定した検証を実現しやすい。

## 料金

| プラン | 内容 |
|------|------|
| OSS 版 | 無料（MIT License） |
| 商用利用 | ライセンス上可能（組織ポリシー確認は必要） |

## 主な特徴

| 項目 | 内容 |
|------|------|
| Node.js 特化 | Node の HTTP 呼び出しを直接モック |
| 柔軟なマッチング | パス、クエリ、ヘッダー、Body、回数制御に対応 |
| 録画機能 | 実通信を fixture 化して再利用可能 |
| テスト統合 | Jest/Mocha/Vitest と組み合わせやすい |
| 失敗系再現 | タイムアウトやネットワークエラーを再現 |

## 主な機能

### モック定義機能

| 機能 | 説明 |
|------|------|
| 基本インターセプト | `nock(baseUrl).get(...).reply(...)` で定義 |
| リクエスト検証 | query/body/header 条件を含めて照合 |
| 呼び出し回数制御 | `times`、`once`、`persist` で制御 |
| 動的レスポンス | 関数でレスポンスを返し分岐可能 |

### テスト支援機能

| 機能 | 説明 |
|------|------|
| pendingMocks | 未消化モックを検知 |
| isDone | 期待リクエスト完了を検証 |
| cleanAll | テスト間の状態汚染をリセット |
| disableNetConnect | 外部通信を禁止し漏れを検出 |

### 録画・再利用機能

| 機能 | 説明 |
|------|------|
| nockBack | 実通信を録画して fixture を生成 |
| fixture 運用 | API 応答をファイル化して共有 |
| 回帰テスト | 既存レスポンスで安定検証 |
| 段階導入 | 既存テストへ部分導入しやすい |

## インストールとセットアップ

公式URL:
- [Nock GitHub](https://github.com/nock/nock)
- [Nock README/API](https://github.com/nock/nock#readme)

セットアップの要点:
1. `nock` を開発依存として追加する。
2. テストセットアップでネットワーク接続制御と後片付けを共通化する。
3. 外部 API を使うテストは fixture 方針を先に決める。

## 基本的な使い方

1. テスト対象の API ドメインごとにモックを定義する。
2. リクエスト条件（パス、クエリ、Body）を必要最小限で指定する。
3. テスト後に `isDone` と `pendingMocks` で未消化モックを検証する。
4. `cleanAll` を実行して次テストへ状態を持ち越さない。

最小コード例:
```javascript
nock('https://api.example.com').get('/health').reply(200, { status: 'ok' })
```

## メリット

- 外部 API 依存を切ってテストを高速化できる
- HTTP 呼び出しの期待値を明示しやすい
- 失敗系ケースを再現しやすい
- Node.js プロジェクトで導入が簡単

## デメリット

- ブラウザ実行コードのモックには直接使えない
- 実装変更でモックが過剰に壊れることがある
- 大規模化すると fixture/モックの保守設計が必要

## 他ツールとの比較

| ツール | 主な対象 | 特徴 |
|------|------|------|
| Nock | Node.js HTTP モック | 軽量でユニットテスト向け |
| MSW | フロントエンド開発/テスト | ブラウザ/Node 両対応 |
| MockServer | 契約テスト/結合テスト | OpenAPI 連携と検証 API |
| WireMock | 言語非依存の HTTP モック | スタンドアロン運用しやすい |

## ベストプラクティス

### 1. 通信遮断をデフォルト化

- `disableNetConnect` を有効化し、漏れた実通信を検知する
- 許可先が必要な場合だけ whitelist を設定する

### 2. モックの責務を小さく保つ

- 1テスト1意図で最小限のモックを定義する
- 共通モックは helper 化して重複を減らす

### 3. 検証を必ず実行

- `isDone` と `pendingMocks` を毎テストで確認する
- 未消化モックを放置しない

## 公式ドキュメント

- GitHub: https://github.com/nock/nock
- README/API: https://github.com/nock/nock#readme

## まとめ

- Node.js の HTTP 通信を軽量にモックでき、ユニットテストを素早く安定化できる。
- 外部通信を遮断しながらテストできるため、テストの再現性と信頼性を高めやすい。
- `isDone` などの検証を徹底することで、未消化モックや想定外通信を早期に検知できる。
