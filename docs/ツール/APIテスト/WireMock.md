# WireMock

## 概要

WireMock は HTTP API のモック・スタブを構築するオープンソースツールである。スタンドアロン実行と Java ライブラリ利用の両方に対応し、外部 API 依存を切り離したテストや開発環境を構築できる。リクエストマッチング、遅延・障害再現、録画・再生など API テストに必要な機能を備える。

## 料金

| プラン | 内容 |
|------|------|
| OSS 版 | 無料（Apache License 2.0） |
| WireMock Cloud | SaaS 版（有料プランあり） |

## 主な特徴

| 項目 | 内容 |
|------|------|
| HTTP モック定番 | 採用事例が多く情報が豊富 |
| 柔軟なマッチング | URL、ヘッダー、Body、Query を細かく定義 |
| 障害再現 | 遅延、タイムアウト、接続エラーを再現 |
| 録画・再生 | 実 API 通信からスタブ生成が可能 |
| 実行形態 | Java 組み込み/スタンドアロン/Docker に対応 |

## 主な機能

### スタブ定義機能

| 機能 | 説明 |
|------|------|
| JSON マッピング | `mappings/*.json` でスタブ管理 |
| Java DSL | テストコードから動的に定義 |
| 優先度設定 | 複数スタブ競合時に優先制御 |
| 状態遷移 | シナリオ機能で stateful API を再現 |

### テスト支援機能

| 機能 | 説明 |
|------|------|
| リクエスト検証 | 呼び出し有無・回数・条件一致を検証 |
| Fault 注入 | 接続リセットや不正応答を再現 |
| 遅延制御 | 固定/ランダム遅延で負荷に近い挙動 |
| ログ確認 | マッチ不一致の原因調査が容易 |

### 運用機能

| 機能 | 説明 |
|------|------|
| REST 管理 API | スタブ追加・削除を実行時に制御 |
| Proxy/Record | 実 API を中継しつつスタブを生成 |
| Docker 運用 | テスト環境での一時起動が簡単 |
| 拡張機能 | カスタム matcher/transformer を追加可能 |

## インストールとセットアップ

公式URL:
- [WireMock 公式サイト](https://wiremock.org/)
- [WireMock Docs](https://wiremock.org/docs/)
- [WireMock GitHub](https://github.com/wiremock/wiremock)
- [Docker Image](https://hub.docker.com/r/wiremock/wiremock)

セットアップの要点:
1. Java テストへ組み込むか、スタンドアロン/Docker で起動するか決める。
2. スタブファイルの配置ルール（`mappings`、`__files`）を先に定義する。
3. テスト実行時に初期化と検証の手順を固定する。

## 基本的な使い方

1. テスト対象 API のエンドポイントごとにスタブを定義する。
2. アプリケーションの接続先を WireMock に切り替えて実行する。
3. リクエスト検証で、想定した API 呼び出し回数と条件一致を確認する。
4. 必要に応じて遅延や Fault を加え、障害系シナリオも確認する。

最小実行例:
- 起動: `java -jar wiremock-standalone.jar --port 8080`
- 疎通: `GET http://localhost:8080/__admin`

## メリット

- 情報量と実績が多く導入しやすい
- スタブ定義方式を用途に応じて選べる
- 障害系テストを作りやすい
- スタンドアロン運用が容易で自動テストと相性が良い

## デメリット

- 大規模スタブは整理ルールがないと複雑化する
- Java 前提の要素があり学習コストが発生する
- OpenAPI 起点の厳密契約検証は専用ツール併用が有効

## Docker での使用

`wiremock/wiremock` コンテナに `mappings` と `__files` をマウントすると、チームで同じスタブセットを共有できる。テスト環境ではポート固定とログ保存先の統一が有効。

## 他ツールとの比較

| ツール | 主な対象 | 特徴 |
|------|------|------|
| WireMock | HTTP モック全般 | 実績が多く運用しやすい |
| MockServer | 契約テスト/高機能モック | OpenAPI 連携と検証 API が強い |
| Prism | OpenAPI 契約検証 | 仕様準拠チェックに特化 |
| MSW | フロントエンド開発 | ブラウザ側モックに強い |

## ベストプラクティス

### 1. スタブをドメイン分割

- `users`、`orders` など機能単位でファイル分割する
- 命名規則を統一して検索性を上げる

### 2. 共通レスポンスを再利用

- `__files` に共通 JSON を置いて重複を減らす
- 変更時の影響範囲を明確化する

### 3. 失敗系ケースを標準化

- タイムアウト、500、接続断を標準シナリオ化する
- 回帰テストへ常に含める

## 公式ドキュメント

- 公式サイト: https://wiremock.org/
- ドキュメント: https://wiremock.org/docs/
- GitHub: https://github.com/wiremock/wiremock
- Docker Hub: https://hub.docker.com/r/wiremock/wiremock

## まとめ

1. **共通運用** : スタンドアロン運用しやすく、ローカル開発から CI まで同じモック構成を再利用できる。
2. **依存排除** : スタブとレスポンス資産を整理することで、外部 API 依存を減らした安定テストを実現しやすい。
3. **障害再現** : 失敗系シナリオを標準化すると、回帰テストの網羅性と再現性を高められる。
