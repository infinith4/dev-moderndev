# OPA (Open Policy Agent)

## 概要

OPA はポリシー判断を外部化するためのオープンソースポリシーエンジンである。インフラ設定、Kubernetes、API 認可などに対して統一ルールを適用でき、ガバナンスと自動チェックを強化しやすい。

## 料金

| プラン | 内容 |
|------|------|
| OSS 版 | 無料（Apache License 2.0） |
| 商用利用 | ライセンス上可能（組織ポリシー確認は必要） |

## 主な特徴

| 項目 | 内容 |
|------|------|
| ポリシー一元化 | 各システムのルールを共通化しやすい |
| Rego 言語 | 宣言的にポリシーを記述可能 |
| 多用途対応 | IaC、Kubernetes、API 認可などに適用 |
| 組み込み/サイドカー | 実行形態を用途に応じて選択 |
| テスト可能 | ポリシー自体をテストできる |

## 主な機能

### ポリシー記述機能

| 機能 | 説明 |
|------|------|
| Rego | ルールを宣言的に定義 |
| 入力データ評価 | JSON 入力に対する判定 |
| 部分評価 | 実行前最適化で高速化 |
| ルール分割 | ドメイン単位で管理可能 |

### 検証・判定機能

| 機能 | 説明 |
|------|------|
| CLI 評価 | ローカルで即時検証 |
| テスト実行 | ポリシーのユニットテスト |
| 監査判断 | 許可/拒否理由の可視化 |
| Bundle 配布 | ポリシー配布を標準化 |

### 運用機能

| 機能 | 説明 |
|------|------|
| Gatekeeper 連携 | Kubernetes ポリシー運用 |
| CI 組み込み | 設定変更時の事前判定 |
| バージョン管理 | ポリシー改定履歴を追跡 |
| 例外管理 | 一時例外ルールを明示 |

## インストールとセットアップ

公式URL:
- [OPA 公式](https://www.openpolicyagent.org/)
- [OPA Docs](https://www.openpolicyagent.org/docs/latest/)
- [OPA GitHub](https://github.com/open-policy-agent/opa)

セットアップの要点:
1. OPA CLI を導入する。
2. `policy` と `data` のディレクトリ構成を決める。
3. 判定対象（IaC、K8s、API）ごとにパッケージを分ける。

## 基本的な使い方

1. まず最小ポリシーで `allow/deny` 条件を定義する。
2. サンプル入力データを用意して `eval` で判定確認する。
3. ポリシーテストを作成して回帰を防ぐ。
4. 運用環境へ適用する前に例外ルールを整理する。

最小コマンド:
- 評価: `opa eval -d policy.rego -i input.json "data.example.allow"`
- テスト: `opa test .`

## メリット

- ポリシーをコードとして管理できる
- ルールの再利用と標準化を進めやすい
- 監査性と説明可能性を高めやすい
- 対象領域を段階的に拡張できる

## デメリット

- Rego 学習コストが発生する
- ルール設計が不十分だと複雑化しやすい
- 運用ルールがないと例外管理が崩れやすい

## 他ツールとの比較

| ツール | 主な対象 | 特徴 |
|------|------|------|
| OPA | 汎用ポリシー評価 | 多用途で共通ポリシー運用が可能 |
| CloudFormation Guard | CloudFormation 検証 | AWS テンプレートに特化 |
| Kyverno | Kubernetes ポリシー | K8s ネイティブ運用に強い |
| Checkov | IaC スキャン | 多 IaC のセキュリティ検査に強い |

## ベストプラクティス

### 1. ルールを小さく分離

- 単一責務のポリシーへ分割する
- 共通ルールはモジュール化する

### 2. テストを必須化

- ルール追加時はテストケースを同時に作成する
- 破壊的変更を防ぐレビュー手順を定義する

### 3. 例外を厳格管理

- 例外には期限・理由を付与する
- 定期的に例外を棚卸しする

## 公式ドキュメント

- 公式サイト: https://www.openpolicyagent.org/
- ドキュメント: https://www.openpolicyagent.org/docs/latest/
- GitHub: https://github.com/open-policy-agent/opa

## まとめ

OPA はポリシーをコード化して統一運用するための強力な基盤である。IaC や認可ルールを横断的に管理したい組織で特に有効である。
