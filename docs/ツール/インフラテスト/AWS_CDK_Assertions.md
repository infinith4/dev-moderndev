# AWS CDK Assertions

## 概要

AWS CDK Assertions は AWS CDK テンプレートに対してテストを行うための機能群である。合成された CloudFormation テンプレートを検証し、意図しないリソース変更や設定漏れを早期に検出できる。

## 料金

| プラン | 内容 |
|------|------|
| ライブラリ本体 | 無料 |
| 補足 | CDK/AWS 利用に伴うリソース料金は別途発生 |

## 主な特徴

| 項目 | 内容 |
|------|------|
| テンプレート検証 | 合成後の CloudFormation をテスト可能 |
| スナップショット検証 | 変更差分の検出に有効 |
| 部分一致検証 | 重要プロパティのみ検証可能 |
| CDK 統合 | CDK プロジェクトに自然に組み込める |
| 早期品質担保 | デプロイ前に設定不備を検出 |

## 主な機能

### 検証機能

| 機能 | 説明 |
|------|------|
| リソース存在確認 | 特定リソースの生成有無を確認 |
| プロパティ検証 | IAM、暗号化、ネットワーク設定を検証 |
| Count 検証 | 期待数どおりリソースが生成されるか確認 |
| 出力検証 | Outputs の値や存在を検証 |

### テスト運用機能

| 機能 | 説明 |
|------|------|
| スナップショット | テンプレート差分を可視化 |
| パターンマッチ | 柔軟な一致条件で検証 |
| ネガティブ検証 | 禁止設定の混入を検出 |
| テスト分離 | スタック単位でテストを分割 |

### 品質強化機能

| 機能 | 説明 |
|------|------|
| セキュリティ確認 | 最小権限や暗号化有効化を検証 |
| 回帰防止 | 意図しない変更を早期検知 |
| レビュー補助 | インフラ差分レビューの判断材料 |
| 標準化 | 組織共通の検証観点を共通化 |

## インストールとセットアップ

公式URL:
- [AWS CDK Assertions Docs](https://docs.aws.amazon.com/cdk/v2/guide/testing.html)
- [AWS CDK GitHub](https://github.com/aws/aws-cdk)

セットアップの要点:
1. CDK プロジェクトにテストランナーを導入する。
2. 合成テンプレートをテスト対象にする構成を準備する。
3. 重要ポリシー（暗号化、公開範囲、タグ）を検証項目として固定する。

## 基本的な使い方

1. CDK スタックを合成してテンプレートを取得する。
2. リソース存在・設定値・件数の順で最小テストを作成する。
3. 重要スタックはスナップショット検証を追加する。
4. 変更時はテスト結果と差分をレビューして反映可否を判断する。

最小実行例:
- テスト実行: `npm test`

## メリット

- デプロイ前に IaC 品質を担保しやすい
- 変更差分のレビュー精度が上がる
- セキュリティ基準を自動検証できる
- CDK 開発フローに自然に組み込める

## デメリット

- テスト設計が不足すると検出漏れが起きる
- スナップショット更新運用にルールが必要
- CDK プロジェクト以外には直接使いにくい

## 他ツールとの比較

| ツール | 主な対象 | 特徴 |
|------|------|------|
| AWS CDK Assertions | CDK テンプレート検証 | CDK との親和性が高い |
| CloudFormation Guard | CFn ポリシー検証 | ルールベースで統制しやすい |
| Terratest | IaC 統合テスト | 実環境寄り検証に強い |
| tflint | Terraform lint | Terraform 静的解析に特化 |

## ベストプラクティス

### 1. 重要観点を固定化

- IAM、暗号化、公開設定を共通テストにする
- スタック追加時に同じ観点を必須化する

### 2. テスト粒度を分離

- 単純な存在確認と詳細設定検証を分ける
- 失敗原因を追いやすい構成にする

### 3. スナップショット運用を明確化

- 意図した差分だけ更新する
- 更新理由を PR に残す

## 公式ドキュメント

- AWS CDK Testing: https://docs.aws.amazon.com/cdk/v2/guide/testing.html
- AWS CDK GitHub: https://github.com/aws/aws-cdk

## まとめ

1. **事前検証** : CDK ベース IaC の品質をデプロイ前に担保するための実践的な検証手段である。
2. **回帰防止** : スナップショット検証により意図しないインフラ変更を早期に検知できる。
3. **自動品質** : セキュリティ基準の自動検証を CDK 開発フローに自然に組み込める。
