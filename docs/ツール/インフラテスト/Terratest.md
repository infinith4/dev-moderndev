# Terratest

## 概要

Terratest は Go で IaC とインフラの実行時検証を行うテストライブラリである。Terraform、Kubernetes、クラウド環境を対象に、実際に構築したリソースへテストを実行して品質を確認できる。

## 料金

| プラン | 内容 |
|------|------|
| OSS 版 | 無料 |
| 商用利用 | ライセンス上可能（組織ポリシー確認は必要） |

## 主な特徴

| 項目 | 内容 |
|------|------|
| 実環境検証 | デプロイ後リソースの挙動を確認可能 |
| Terraform 親和性 | apply/destroy をテストから制御可能 |
| Go ベース | テストロジックを柔軟に記述可能 |
| 再利用しやすい | 共通 helper 化で標準化しやすい |
| 回帰防止 | IaC 変更の実害を早期検知 |

## 主な機能

### IaC テスト機能

| 機能 | 説明 |
|------|------|
| Terraform 実行制御 | init/plan/apply/destroy を自動化 |
| 出力値検証 | outputs の値をテストで確認 |
| 依存疎通確認 | エンドポイントやネットワーク接続を検証 |
| リソース存在確認 | 実クラウド API で状態確認 |

### テスト設計機能

| 機能 | 説明 |
|------|------|
| テスト分割 | 単体観点と統合観点を分離 |
| 再試行制御 | 一時エラーに対するリトライ |
| ランダム命名 | テスト環境衝突を回避 |
| cleanup | テスト後のリソース削除を自動化 |

### 品質強化機能

| 機能 | 説明 |
|------|------|
| 実環境回帰検知 | IaC 変更影響を高精度に検出 |
| セキュリティ確認 | 公開設定や暗号化などを確認 |
| 信頼性向上 | デプロイ手順の再現性を担保 |
| 監査補助 | テスト結果を証跡化しやすい |

## インストールとセットアップ

公式URL:
- [Terratest GitHub](https://github.com/gruntwork-io/terratest)
- [Terratest Docs](https://terratest.gruntwork.io/)

セットアップの要点:
1. Go 環境を準備し Terratest を導入する。
2. テスト対象 IaC ディレクトリ構成を整理する。
3. テスト用クラウドアカウントとクリーンアップ方針を決める。

## 基本的な使い方

1. まず最小構成で apply と destroy が通るテストを作る。
2. 次に outputs と疎通確認を追加する。
3. 失敗時でも cleanup される設計にする。
4. リソース名衝突を避けるため一意命名を導入する。

最小コマンド:
- テスト実行: `go test ./test -v`

## メリット

- IaC の実害を伴う不具合を早期に検出できる
- 実運用に近い検証で信頼性が高い
- Go の柔軟性で複雑な確認が可能
- IaC 回帰テストを標準化しやすい

## デメリット

- 実クラウド実行のため時間とコストがかかる
- テスト設計が弱いと flake が発生しやすい
- Go とクラウド API の知識が必要

## 他ツールとの比較

| ツール | 主な対象 | 特徴 |
|------|------|------|
| Terratest | IaC 実行時検証 | 実環境での統合テストに強い |
| AWS CDK Assertions | CDK テンプレート検証 | 合成テンプレート検証に特化 |
| tflint | Terraform lint | 静的解析中心 |
| InSpec | 構成監査 | コンプライアンス検証に強い |

## ベストプラクティス

### 1. テスト階層を分離

- 軽量テストと重い統合テストを分ける
- 実行時間を制御しやすくする

### 2. cleanup を必須化

- 失敗時も `destroy` を保証する
- 残存リソースを定期棚卸しする

### 3. 検証観点を固定

- 接続性、セキュリティ、出力値を標準観点にする
- 新規モジュール追加時も同じ基準で確認する

## 公式ドキュメント

- GitHub: https://github.com/gruntwork-io/terratest
- ドキュメント: https://terratest.gruntwork.io/

## まとめ

1. ** 実環境 ** : IaC の実行結果を本番に近い形で検証できる実用的なテスト手法である。
2. ** 回帰防止 ** : インフラ変更の回帰リスクを早期に検出し、品質を担保しやすい。
3. ** 標準化 ** : 共通 helper 化によりテスト観点を統一し、IaC 回帰テストを標準化できる。
