# CodeQL

## æ¦‚è¦

**CodeQL**ã¯ã€GitHubãŒé–‹ç™ºã—ãŸã‚³ãƒ¼ãƒ‰è§£æã‚¨ãƒ³ã‚¸ãƒ³ã§ã™ã€‚ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯è§£æã«ã‚ˆã‚Šã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãƒ»ãƒã‚°ã‚’ã‚³ãƒ¼ãƒ‰ã‹ã‚‰æ¤œå‡ºã—ã€GitHub Advanced Securityã®ä¸€éƒ¨ã¨ã—ã¦ã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ®µéšã§ã®è‡ªå‹•ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

## åŸºæœ¬æƒ…å ±

| é …ç›® | å†…å®¹ |
|------|------|
| **é–‹ç™ºå…ƒ** | GitHubï¼ˆSemmleè²·åï¼‰ |
| **ç¨®åˆ¥** | ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ã‚³ãƒ¼ãƒ‰è§£æã‚¨ãƒ³ã‚¸ãƒ³ |
| **ãƒ©ã‚¤ã‚»ãƒ³ã‚¹** | ãƒ—ãƒ­ãƒ—ãƒ©ã‚¤ã‚¨ã‚¿ãƒªï¼ˆã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã¯ç„¡æ–™ï¼‰ |
| **æ–™é‡‘** | ğŸŸ¡ Freeï¼ˆãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒªãƒã‚¸ãƒˆãƒªï¼‰/ æœ‰æ–™ï¼ˆGitHub Advanced Securityï¼‰ |
| **å…¬å¼ã‚µã‚¤ãƒˆ** | https://codeql.github.com/ |
| **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ** | https://codeql.github.com/docs/ |

## ä¸»ãªç‰¹å¾´

### 1. ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯è§£æ
- **ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼åˆ†æ**: å¤‰æ•°ã®è¿½è·¡
- **åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼åˆ†æ**: ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å®Ÿè¡Œãƒ‘ã‚¹
- **ã‚³ãƒ¼ãƒ«ã‚°ãƒ©ãƒ•**: é–¢æ•°å‘¼ã³å‡ºã—é–¢ä¿‚
- **ã‚¯ã‚¨ãƒªè¨€èª**: SQLãƒ©ã‚¤ã‚¯ãªã‚¯ã‚¨ãƒªã§ã‚³ãƒ¼ãƒ‰æ¤œç´¢

### 2. è„†å¼±æ€§æ¤œå‡º
- **OWASP Top 10**: SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã€XSSç­‰
- **CWE**: Common Weakness Enumeration
- **ã‚«ã‚¹ã‚¿ãƒ ã‚¯ã‚¨ãƒª**: ç‹¬è‡ªãƒ«ãƒ¼ãƒ«å®šç¾©
- **èª¤æ¤œçŸ¥ä½æ¸›**: ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯è§£æã«ã‚ˆã‚‹ç²¾åº¦å‘ä¸Š

### 3. GitHubçµ±åˆ
- **GitHub Actions**: è‡ªå‹•ã‚¹ã‚­ãƒ£ãƒ³
- **Code Scanning**: PRç”»é¢ã«ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
- **Security Advisory**: è„†å¼±æ€§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
- **Dependaboté€£æº**: ä¾å­˜é–¢ä¿‚è„†å¼±æ€§

### 4. å¤šè¨€èªå¯¾å¿œ
- **Java**: Springã€Strutsç­‰ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
- **JavaScript/TypeScript**: Node.jsã€Reactç­‰
- **Python**: Djangoã€Flaskç­‰
- **C/C++ã€C#ã€Goã€Ruby**: å¹…åºƒã„å¯¾å¿œ

## ä½¿ã„æ–¹

### GitHub Actions ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```yaml
# .github/workflows/codeql-analysis.yml
name: "CodeQL"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 1'  # æ¯é€±æœˆæ›œæ—¥0æ™‚

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ 'javascript', 'python' ]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: ${{ matrix.language }}
        queries: security-and-quality

    - name: Autobuild
      uses: github/codeql-action/autobuild@v2

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
      with:
        category: "/language:${{matrix.language}}"
```

### Java ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ

```yaml
# .github/workflows/codeql-analysis.yml
jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: java

    - name: Build with Maven
      run: mvn clean install -DskipTests

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
```

### C/C++ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ

```yaml
# .github/workflows/codeql-analysis.yml
jobs:
  analyze:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v2
      with:
        languages: cpp

    - name: Build
      run: |
        mkdir build
        cd build
        cmake ..
        make

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v2
```

### ã‚«ã‚¹ã‚¿ãƒ ã‚¯ã‚¨ãƒª

```yaml
# .github/workflows/codeql-analysis.yml
steps:
- name: Initialize CodeQL
  uses: github/codeql-action/init@v2
  with:
    languages: javascript
    queries: security-and-quality, ./.github/codeql/custom-queries.qls
```

```yaml
# .github/codeql/custom-queries.qls
- queries: .
  from: codeql/javascript-queries
- queries: .
  from: ./.github/codeql/custom
```

```ql
# .github/codeql/custom/sql-injection.ql
/**
 * @name SQL injection
 * @description User input flows to SQL query without sanitization
 * @kind path-problem
 * @problem.severity error
 * @id js/sql-injection-custom
 */

import javascript
import DataFlow::PathGraph

class SqlInjectionConfig extends TaintTracking::Configuration {
  SqlInjectionConfig() { this = "SqlInjectionConfig" }

  override predicate isSource(DataFlow::Node source) {
    source instanceof RemoteFlowSource
  }

  override predicate isSink(DataFlow::Node sink) {
    exists(SQL::SqlString s |
      s.getAnArgument() = sink.asExpr()
    )
  }
}

from SqlInjectionConfig cfg, DataFlow::PathNode source, DataFlow::PathNode sink
where cfg.hasFlowPath(source, sink)
select sink.getNode(), source, sink, "SQL injection from $@.", source.getNode(), "user input"
```

### CLIä½¿ç”¨ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«è§£æï¼‰

```bash
# CodeQL CLI ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
wget https://github.com/github/codeql-cli-binaries/releases/latest/download/codeql-linux64.zip
unzip codeql-linux64.zip
export PATH=$PATH:$(pwd)/codeql

# CodeQLã‚¯ã‚¨ãƒªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¯ãƒ­ãƒ¼ãƒ³
git clone https://github.com/github/codeql.git codeql-repo

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆï¼ˆJavaScriptï¼‰
codeql database create myapp-db --language=javascript --source-root=./myapp

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆï¼ˆJava - Mavenï¼‰
codeql database create myapp-db --language=java --command="mvn clean install -DskipTests"

# ã‚¯ã‚¨ãƒªå®Ÿè¡Œ
codeql query run codeql-repo/javascript/ql/src/Security/CWE-079/XSS.ql --database=myapp-db

# è§£æå®Ÿè¡Œ
codeql database analyze myapp-db \
  codeql-repo/javascript/ql/src/codeql-suites/javascript-security-and-quality.qls \
  --format=sarif-latest \
  --output=results.sarif

# SARIFçµæœè¡¨ç¤º
codeql github upload-results \
  --repository=owner/repo \
  --ref=refs/heads/main \
  --commit=$(git rev-parse HEAD) \
  --sarif=results.sarif
```

### VS Codeçµ±åˆ

```bash
# VS Codeæ‹¡å¼µæ©Ÿèƒ½ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
code --install-extension GitHub.vscode-codeql

# ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹è¨­å®š
# .vscode/settings.json
{
  "codeQL.cli.executablePath": "/path/to/codeql/codeql",
  "codeQL.runningQueries.numberOfThreads": 4
}
```

### SARIF ãƒ¬ãƒãƒ¼ãƒˆ

```json
{
  "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
  "version": "2.1.0",
  "runs": [
    {
      "tool": {
        "driver": {
          "name": "CodeQL",
          "version": "2.10.0",
          "rules": [
            {
              "id": "js/sql-injection",
              "name": "SQL injection",
              "shortDescription": {
                "text": "SQL injection vulnerability"
              }
            }
          ]
        }
      },
      "results": [
        {
          "ruleId": "js/sql-injection",
          "level": "error",
          "message": {
            "text": "User input flows to SQL query"
          },
          "locations": [
            {
              "physicalLocation": {
                "artifactLocation": {
                  "uri": "src/controllers/user.js"
                },
                "region": {
                  "startLine": 42,
                  "startColumn": 10
                }
              }
            }
          ]
        }
      ]
    }
  ]
}
```

### ã‚«ã‚¹ã‚¿ãƒ ã‚¯ã‚¨ãƒªä¾‹ï¼ˆXSSæ¤œå‡ºï¼‰

```ql
/**
 * @name Cross-site scripting
 * @description User input rendered without escaping
 * @kind path-problem
 * @problem.severity error
 * @id js/xss-custom
 */

import javascript
import semmle.javascript.security.dataflow.DomBasedXssQuery
import DataFlow::PathGraph

from Configuration cfg, DataFlow::PathNode source, DataFlow::PathNode sink
where cfg.hasFlowPath(source, sink)
select sink.getNode(), source, sink,
  "Cross-site scripting vulnerability from $@.", source.getNode(), "user input"
```

### GitLabçµ±åˆ

```yaml
# .gitlab-ci.yml
codeql:
  image: ghcr.io/github/codeql-action/codeql-runner:latest
  script:
    - codeql database create codeql-db --language=javascript
    - codeql database analyze codeql-db \
        --format=sarif-latest \
        --output=results.sarif \
        javascript-security-and-quality.qls
  artifacts:
    reports:
      sast: results.sarif
```

### Jenkinsçµ±åˆ

```groovy
// Jenkinsfile
pipeline {
    agent any

    stages {
        stage('CodeQL Analysis') {
            steps {
                sh '''
                    codeql database create codeql-db --language=java --command="mvn clean install -DskipTests"
                    codeql database analyze codeql-db \
                        --format=sarif-latest \
                        --output=results.sarif \
                        java-security-and-quality.qls
                '''

                recordIssues(
                    enabledForFailure: true,
                    tool: sarif(pattern: 'results.sarif')
                )
            }
        }
    }
}
```

## é–‹ç™ºå·¥ç¨‹ã§ã®åˆ©ç”¨

| å·¥ç¨‹ | ç”¨é€” | è©³ç´° |
|------|------|------|
| **å®Ÿè£…** | PR ãƒ¬ãƒ“ãƒ¥ãƒ¼ | ã‚³ãƒŸãƒƒãƒˆæ™‚ã®è‡ªå‹•ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ |
| **ãƒ†ã‚¹ãƒˆ** | é™çš„è§£æ | è„†å¼±æ€§æ¤œå‡º |
| **ãƒ†ã‚¹ãƒˆ** | ã‚³ãƒ¼ãƒ‰å“è³ª | ãƒã‚°ãƒ»ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º |
| **CI/CD** | ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚²ãƒ¼ãƒˆ | ãƒ“ãƒ«ãƒ‰ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§ã®è‡ªå‹•ã‚¹ã‚­ãƒ£ãƒ³ |

## ãƒ¡ãƒªãƒƒãƒˆ

- **ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯è§£æ**: èª¤æ¤œçŸ¥ä½æ¸›ã€é«˜ç²¾åº¦
- **å¤šè¨€èªå¯¾å¿œ**: ä¸»è¦è¨€èªã‚µãƒãƒ¼ãƒˆ
- **GitHubçµ±åˆ**: PRç”»é¢ã«ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
- **ã‚«ã‚¹ã‚¿ãƒ ã‚¯ã‚¨ãƒª**: ç‹¬è‡ªãƒ«ãƒ¼ãƒ«å®šç¾©å¯èƒ½
- **OWASP/CWEå¯¾å¿œ**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¨™æº–æº–æ‹ 
- **ç„¡æ–™**: ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒªãƒã‚¸ãƒˆãƒªç„¡æ–™
- **ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è¿½è·¡**: è¤‡é›‘ãªè„†å¼±æ€§æ¤œå‡º

## ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

- **æ–™é‡‘**: ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒªãƒã‚¸ãƒˆãƒªã¯GitHub Advanced Securityå¿…è¦ï¼ˆæœ‰æ–™ï¼‰
- **å­¦ç¿’æ›²ç·š**: ã‚¯ã‚¨ãƒªè¨€èªã®ç¿’å¾—
- **å®Ÿè¡Œæ™‚é–“**: å¤§è¦æ¨¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§æ™‚é–“ãŒã‹ã‹ã‚‹
- **GitHubä¾å­˜**: GitHub Actionsæ¨å¥¨
- **ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—**: åˆæœŸè¨­å®šãŒè¤‡é›‘
- **ãƒ“ãƒ«ãƒ‰å¿…è¦**: ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«è¨€èªã¯ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒƒãƒ—å¿…é ˆ

## é¡ä¼¼ãƒ„ãƒ¼ãƒ«ã¨ã®æ¯”è¼ƒ

| ãƒ„ãƒ¼ãƒ« | ç‰¹å¾´ | æ–™é‡‘ | é©ç”¨å ´é¢ |
|--------|------|------|----------|
| **CodeQL** | ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯è§£æã€GitHubçµ±åˆ | ç„¡æ–™/æœ‰æ–™ | GitHubä¸­å¿ƒé–‹ç™º |
| **SonarQube** | å“è³ªãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç·åˆ | ç„¡æ–™/æœ‰æ–™ | ç·åˆå“è³ªç®¡ç† |
| **Snyk Code** | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã€IDEçµ±åˆ | ç„¡æ–™/æœ‰æ–™ | é–‹ç™ºä¸­ã®è„†å¼±æ€§æ¤œå‡º |
| **Checkmarx** | ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºSAST | æœ‰æ–™ | å¤§è¦æ¨¡çµ„ç¹” |

## ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. PRã§ã®è‡ªå‹•ã‚¹ã‚­ãƒ£ãƒ³

```yaml
on:
  pull_request:
    branches: [ main ]
```

### 2. ã‚«ã‚¹ã‚¿ãƒ ã‚¯ã‚¨ãƒªã§çµ„ç¹”å›ºæœ‰ãƒ«ãƒ¼ãƒ«

```yaml
queries: security-and-quality, ./.github/codeql/custom-queries.qls
```

### 3. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œã§å®šæœŸã‚¹ã‚­ãƒ£ãƒ³

```yaml
on:
  schedule:
    - cron: '0 0 * * 1'  # æ¯é€±æœˆæ›œæ—¥
```

### 4. ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ãƒ“ãƒ«ãƒ‰ã§è¤‡æ•°è¨€èª

```yaml
strategy:
  matrix:
    language: [ 'javascript', 'python', 'java' ]
```

## å…¬å¼ãƒªã‚½ãƒ¼ã‚¹

- **å…¬å¼ã‚µã‚¤ãƒˆ**: https://codeql.github.com/
- **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: https://codeql.github.com/docs/
- **ã‚¯ã‚¨ãƒªãƒªãƒã‚¸ãƒˆãƒª**: https://github.com/github/codeql
- **CLI**: https://github.com/github/codeql-cli-binaries
- **VS Codeæ‹¡å¼µ**: https://marketplace.visualstudio.com/items?itemName=GitHub.vscode-codeql

## ã¾ã¨ã‚

CodeQLã¯ã€GitHubãŒé–‹ç™ºã—ãŸã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ã‚³ãƒ¼ãƒ‰è§£æã‚¨ãƒ³ã‚¸ãƒ³ã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ãƒ»åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼åˆ†æã«ã‚ˆã‚Šã€SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãƒ»XSSç­‰ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ã‚’é«˜ç²¾åº¦ã§æ¤œå‡ºã—ã¾ã™ã€‚GitHub Advanced Securityã®ä¸€éƒ¨ã¨ã—ã¦ã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ®µéšã§ã®è‡ªå‹•ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿç¾ã—ã€ã‚·ãƒ•ãƒˆãƒ¬ãƒ•ãƒˆãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã‚’æ”¯æ´ã—ã¾ã™ã€‚

---

**æœ€çµ‚æ›´æ–°**: 2025-12-10
**å¯¾è±¡ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: CodeQL CLI 2.15+
