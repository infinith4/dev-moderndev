# k6

## 概要

k6は、Grafana Labs製のオープンソース負荷テストツールです。JavaScript DSL、CLI実行、メトリクス（HTTP、WebSocket）、シナリオベーステスト、負荷プロファイル（ランプアップ、スパイク）により、Webアプリケーションのパフォーマンステスト・負荷テストを実現します。開発者フレンドリー、CI/CD統合、Grafana/Prometheusエクスポートで広く採用されています。

## 主な機能

### 1. 負荷テスト
- **HTTP**: REST API、Webサイト
- **WebSocket**: WebSocket接続
- **gRPC**: gRPCサービス
- **ブラウザ**: ヘッドレスブラウザ

### 2. シナリオ
- **Virtual Users**: VU数設定
- **ランプアップ**: 徐々に負荷増加
- **スパイク**: 急激な負荷
- **ステップ**: 段階的負荷

### 3. メトリクス
- **HTTP**: レスポンスタイム、成功率
- **カスタムメトリクス**: Counter、Gauge、Trend
- **Checks**: アサーション
- **Thresholds**: 合格基準

### 4. 統合
- **Grafana Cloud**: k6 Cloud
- **Prometheus**: Prometheusエクスポート
- **CI/CD**: GitHub Actions、GitLab CI

## 利用方法

### インストール

```bash
# macOS
brew install k6

# Linux
sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
sudo apt-get update
sudo apt-get install k6

# Docker
docker pull grafana/k6
```

### 基本スクリプト

```javascript
// script.js
import http from 'k6/http';
import { check, sleep } from 'k6';

export let options = {
  vus: 10,           // 10 Virtual Users
  duration: '30s',   // 30秒間実行
};

export default function () {
  let response = http.get('https://test.k6.io');

  check(response, {
    'status is 200': (r) => r.status === 200,
    'response time < 500ms': (r) => r.timings.duration < 500,
  });

  sleep(1);
}
```

```bash
# 実行
k6 run script.js
```

### ランプアップ

```javascript
export let options = {
  stages: [
    { duration: '30s', target: 20 },   // 30秒で20 VUまで増加
    { duration: '1m', target: 100 },   // 1分で100 VUまで増加
    { duration: '30s', target: 0 },    // 30秒で0 VUまで減少
  ],
};

export default function () {
  http.get('https://test.k6.io');
  sleep(1);
}
```

### POST リクエスト

```javascript
import http from 'k6/http';

export default function () {
  let url = 'https://httpbin.test.k6.io/post';
  let payload = JSON.stringify({
    name: 'Alice',
    email: 'alice@example.com',
  });

  let params = {
    headers: {
      'Content-Type': 'application/json',
    },
  };

  let response = http.post(url, payload, params);
  check(response, {
    'status is 200': (r) => r.status === 200,
  });
}
```

### Checks と Thresholds

```javascript
import http from 'k6/http';
import { check } from 'k6';

export let options = {
  thresholds: {
    http_req_duration: ['p(95)<500'],   // 95%ile < 500ms
    http_req_failed: ['rate<0.01'],     // エラー率 < 1%
    checks: ['rate>0.95'],              // Check成功率 > 95%
  },
};

export default function () {
  let response = http.get('https://test.k6.io');

  check(response, {
    'status is 200': (r) => r.status === 200,
    'body contains text': (r) => r.body.includes('Collection'),
  });
}
```

### カスタムメトリクス

```javascript
import http from 'k6/http';
import { Counter, Gauge, Trend } from 'k6/metrics';

let myCounter = new Counter('my_counter');
let myGauge = new Gauge('my_gauge');
let myTrend = new Trend('my_trend');

export default function () {
  let response = http.get('https://test.k6.io');

  myCounter.add(1);
  myGauge.add(response.body.length);
  myTrend.add(response.timings.duration);
}
```

### シナリオ

```javascript
export let options = {
  scenarios: {
    constant_load: {
      executor: 'constant-vus',
      vus: 10,
      duration: '30s',
    },
    ramping_load: {
      executor: 'ramping-vus',
      startVUs: 0,
      stages: [
        { duration: '10s', target: 50 },
        { duration: '20s', target: 100 },
      ],
    },
  },
};

export default function () {
  http.get('https://test.k6.io');
}
```

### CI/CD統合（GitHub Actions）

```yaml
name: k6 Load Test

on: [push]

jobs:
  k6-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Run k6 test
        uses: grafana/k6-action@v0.3.0
        with:
          filename: script.js
          flags: --out json=results.json

      - name: Upload results
        uses: actions/upload-artifact@v3
        with:
          name: k6-results
          path: results.json
```

### Docker実行

```bash
docker run -i grafana/k6 run - < script.js

# ファイルマウント
docker run -i -v $(pwd):/scripts grafana/k6 run /scripts/script.js
```

## エディション・料金

| エディション | 価格 | 特徴 |
|-------------|------|------|
| **k6 OSS** |  無料 | オープンソース、AGPLv3 License |
| **Grafana Cloud k6** |  $49/月〜 | クラウド実行、分散テスト |

## メリット

1. **無料**: オープンソース
2. **開発者フレンドリー**: JavaScript DSL
3. **CLI**: シンプルCLI
4. **CI/CD統合**: GitHub Actions、GitLab CI
5. **メトリクス**: 詳細メトリクス

## デメリット

1. **ブラウザ制限**: ヘッドレスブラウザ限定的
2. **分散実行**: OSS版は単一マシン
3. **GUI**: GUI非対応
4. **学習曲線**: JavaScript学習必要

## 公式リンク

- **公式サイト**: [https://k6.io/](https://k6.io/)
- **ドキュメント**: [https://k6.io/docs/](https://k6.io/docs/)

## 関連ドキュメント

- [負荷テストツール一覧](../負荷テストツール/)
- [JMeter](./JMeter.md)
- [Gatling](./Gatling.md)

---

**カテゴリ**: 負荷テストツール
**対象工程**: パフォーマンステスト
**最終更新**: 2025年12月
**ドキュメントバージョン**: 1.0

