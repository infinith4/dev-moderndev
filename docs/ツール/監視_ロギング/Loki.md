# Loki

## 概要

Loki は Grafana Labs が提供するログ集約システムである。ラベル中心の設計によりログ検索コストを抑えつつ、Grafana と連携して運用調査を行いやすい。

## 料金

| 区分 | 内容 |
|------|------|
| Loki OSS | 無料 |
| Grafana Cloud Logs | 有料プランあり |

## 主な特徴

| 項目 | 内容 |
|------|------|
| ラベル指向 | メトリクス的な運用でログを扱える |
| Grafana 親和性 | 可視化・検索を統合しやすい |
| スケーラブル | 分散構成で拡張可能 |
| 低コスト志向 | フルテキスト索引に比べコスト抑制しやすい |
| エコシステム | Promtail 等と連携しやすい |

## 主な機能

### ログ収集機能

| 機能 | 説明 |
|------|------|
| 収集エージェント連携 | Promtail などから取り込み |
| ラベル付与 | サービス/環境単位で分類 |
| 保持管理 | 保持期間・ストレージ方針を設定 |
| マルチテナント | 環境分離に対応 |

### 検索・可視化機能

| 機能 | 説明 |
|------|------|
| LogQL | ラベルとログ内容で検索 |
| フィルタ集計 | エラー傾向や件数を分析 |
| Grafana 表示 | ダッシュボードで運用可視化 |
| 相関分析 | メトリクス/トレースと連携可能 |

### 運用機能

| 機能 | 説明 |
|------|------|
| ストレージ選択 | オブジェクトストレージ活用 |
| コンパクション | 保管効率を最適化 |
| 監視連携 | Loki 自体の健全性監視が可能 |
| 権限制御 | テナント・用途別アクセス制御 |

## インストールとセットアップ

公式URL:
- [Loki 公式](https://grafana.com/oss/loki/)
- [Loki Docs](https://grafana.com/docs/loki/latest/)

セットアップ手順:
1. Loki と収集エージェントを導入する。
2. ラベル設計（環境・サービス・インスタンス）を定義する。
3. 保存先と保持期間を運用要件に合わせる。
4. Grafana で検索・可視化ダッシュボードを作成する。

## 基本的な使い方

1. まず重要サービスのログだけ収集対象にする。
2. ラベル粒度を過不足なく調整する。
3. 代表的な障害調査クエリをテンプレート化する。
4. 保持期間と検索速度を定期的に見直す。

## メリット

- 監視基盤とログ運用を統合しやすい
- コストを抑えたログ運用に向く
- Grafana 連携で調査導線を作りやすい
- ラベル設計で運用整理しやすい

## デメリット

- ラベル設計を誤ると検索性が低下する
- 高度分析は別基盤併用が必要な場合がある
- 初期運用設計に経験が必要

## 他ツールとの比較

| ツール | 主な用途 | 特徴 |
|------|------|------|
| Loki | ログ集約/検索 | ラベル中心でコスト最適化しやすい |
| Elasticsearch | ログ検索 | フルテキスト検索に強い |
| CloudWatch Logs | AWS ログ管理 | AWS 統合運用に強い |
| Splunk | ログ分析 | 高機能な商用分析基盤 |

## ベストプラクティス

### 1. ラベルを厳選

- 検索で使う項目のみラベル化する
- 高カーディナリティを避ける

### 2. 保持方針を明確化

- 監査要件とコストを両立する
- ホット/コールド運用を検討する

### 3. 調査テンプレートを作る

- 障害別の LogQL を共有する
- オンコール対応を標準化する

## 公式ドキュメント

- 公式サイト: https://grafana.com/oss/loki/
- ドキュメント: https://grafana.com/docs/loki/latest/
- GitHub: https://github.com/grafana/loki

## まとめ

1. Loki はログ運用コスト最適化に有効。
2. ラベル設計と保持方針が成功の鍵。
3. 調査テンプレート整備で運用効率が上がる。
