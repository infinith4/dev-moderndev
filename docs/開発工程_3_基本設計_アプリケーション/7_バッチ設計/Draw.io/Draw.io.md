# Draw.io（バッチ設計）

## 概要

Draw.io（diagrams.net）は、完全無料のオンライン図作成ツールで、基本設計フェーズではバッチ処理フロー図、ジョブネットワーク図、データフロー図の作成に活用します。バッチ処理の流れ、タスク間の依存関係、エラーハンドリングの可視化が可能です。

### 基本設計フェーズでの活用

- **バッチ処理フロー図**: バッチ処理の全体フローを可視化
- **ジョブネットワーク図**: 複数ジョブの依存関係と実行順序
- **データフロー図**: データの入出力と変換処理の流れ
- **エラーハンドリングフロー**: エラー発生時の処理分岐
- **スケジュール図**: バッチ実行タイミングの可視化

### メリット・デメリット

**メリット**
- 完全無料で広告なし
- フローチャート用のシェイプが豊富
- BPMN、UML Activity Diagramに対応
- SVG/PNG/PDFエクスポート対応
- Google Drive統合でバージョン管理が容易

**デメリット**
- 実行可能なバッチコードを生成できない
- 大規模なバッチフローの管理が困難
- リアルタイム協業機能が弱い

## 利用方法

### 1. Draw.ioへのアクセスとフローチャート作成

1. [diagrams.net](https://www.diagrams.net/)にアクセス
2. 保存先を選択（Device、Google Drive、OneDrive等）
3. 「Create New Diagram」をクリック
4. テンプレートから「Basic」→「Flowchart」を選択

### 2. フローチャートライブラリの有効化

1. 左パネルで「More Shapes...」をクリック
2. 以下のライブラリにチェック:
   - **General**: 基本図形
   - **Flowchart**: フローチャート専用シェイプ
   - **BPMN**: ビジネスプロセスモデリング
3. 「Apply」をクリック

### 3. バッチ処理フロー図の作成

#### 例: 日次売上集計バッチ

**フローチャート要素:**

| 要素 | 図形 | 用途 |
|------|------|------|
| 開始/終了 | 楕円 | バッチの開始・終了 |
| 処理 | 四角形 | データ抽出、変換、集計等 |
| 判定 | 菱形 | 条件分岐 |
| データ | 平行四辺形 | 入出力ファイル、DB |
| サブプロセス | 角丸四角形 | サブバッチ呼び出し |

#### バッチ処理フロー図の作成手順

**1. 開始ノードの配置**

1. 左パネルの「Flowchart」から「Terminator」（楕円）を配置
2. テキスト: "開始（毎日2:00 AM）"

**2. データ抽出処理の配置**

1. 「Process」（四角形）を配置
2. テキスト: "データ抽出\nMySQLから前日売上データ抽出"

**3. データソースの配置**

1. 「Data」（平行四辺形）を配置
2. テキスト: "DB: orders\n(前日売上データ)"

**4. 矢印で接続**

1. 「Arrow」で各要素を接続
2. 開始 → データソース → データ抽出

**5. 完全なバッチフロー**

```
┌──────────────────┐
│ 開始（毎日2:00 AM） │
└─────────┬────────┘
          ↓
┌─────────────────┐
│ DB: orders      │
│ (前日売上データ)  │
└─────────┬───────┘
          ↓
┌─────────────────┐
│ データ抽出       │
│ SELECT * FROM   │
│ orders WHERE... │
└─────────┬───────┘
          ↓
      <件数チェック>
     /            \
  0件              1件以上
    ↓              ↓
┌────────┐    ┌─────────┐
│ ログ記録 │    │ データ変換 │
│ 終了    │    │ クレンジング │
└────────┘    └─────┬───┘
                    ↓
              ┌─────────┐
              │ データ集計 │
              │ 商品別集計 │
              └─────┬───┘
                    ↓
              ┌──────────┐
              │ レポート生成 │
              │ CSVファイル │
              └─────┬────┘
                    ↓
              ┌──────────┐
              │ S3へ保存  │
              │ s3://... │
              └─────┬────┘
                    ↓
              ┌──────────┐
              │ メール送信 │
              │ 完了通知  │
              └─────┬────┘
                    ↓
              ┌──────────┐
              │ 終了      │
              └──────────┘
```

### 4. ジョブネットワーク図の作成

#### 複数ジョブの依存関係を可視化

**例: 月次処理バッチ群**

```
┌──────────────┐
│ 日次集計バッチ  │
│ (毎日2:00)    │
└───────┬──────┘
        ↓ 30日分蓄積
┌──────────────┐     ┌──────────────┐
│ 月次売上集計   │     │ 月次在庫集計   │
│ (月初3:00)    │     │ (月初3:00)    │
└───────┬──────┘     └───────┬──────┘
        │                    │
        └─────────┬──────────┘
                  ↓
        ┌──────────────┐
        │ 月次レポート生成 │
        │ (月初4:00)    │
        └───────┬──────┘
                ↓
        ┌──────────────┐
        │ 経営陣へ送信   │
        └──────────────┘
```

**Draw.ioでの作成手順:**

1. 各バッチをRectangle（四角形）で表現
2. バッチ名とスケジュールを記載
3. Arrowで依存関係を接続
4. ラベルに実行条件を追加（例: "30日分蓄積後"）

### 5. データフロー図（DFD）の作成

#### レベル0 DFD（コンテキスト図）

```
┌──────────┐
│ 販売システム │
└─────┬────┘
      ↓ 売上データ
┌─────────────┐
│ 日次売上集計  │
│ バッチ       │
└─────┬───────┘
      ↓ レポート
┌──────────┐
│ 経営者    │
└──────────┘
```

#### レベル1 DFD（詳細データフロー）

```
┌──────────┐
│ orders   │
│ テーブル  │
└─────┬────┘
      ↓ 売上データ
┌─────────────┐
│ 1. データ抽出 │
└─────┬───────┘
      ↓ 生データ
┌─────────────┐
│ 2. データ変換 │
│ クレンジング  │
└─────┬───────┘
      ↓ 変換済みデータ
┌─────────────┐
│ 3. データ集計 │
│ 商品別集計   │
└─────┬───────┘
      ↓ 集計データ
┌─────────────┐
│ 4. CSV生成  │
└─────┬───────┘
      ↓ sales_summary.csv
┌─────────────┐
│ S3バケット   │
└─────────────┘
```

**データストアの表記:**

1. 「Flowchart」から「Stored Data」を使用
2. または、2本の平行線で挟んだ四角形
3. ラベル: "D1: orders"（D1はデータストア番号）

### 6. エラーハンドリングフローの設計

#### エラー発生時の分岐処理

```
┌─────────────┐
│ データ抽出   │
└─────┬───────┘
      ↓
  <成功？>
  /      \
失敗      成功
  ↓        ↓
┌────────┐ ┌─────────┐
│ リトライ │ │ データ変換 │
│ 5分後  │ └─────────┘
└────┬───┘
     ↓
  <3回失敗？>
  /      \
Yes      No
  ↓       ↓
┌────────┐ ┌────────┐
│ アラート │ │ リトライ │
│ メール  │ │ 再実行  │
└────┬───┘ └────────┘
     ↓
┌────────┐
│ 処理中断 │
└────────┘
```

**菱形（判定）での条件記載:**

- 条件を菱形内に記載: "成功？"、"件数 > 0？"
- Yesの矢印にラベル: "Yes"または"成功"
- Noの矢印にラベル: "No"または"失敗"

### 7. 並列処理の可視化

#### 複数タスクの並列実行

```
┌─────────────┐
│ データ抽出   │
└─────┬───────┘
      ↓
      ├─────────────────┐
      ↓                 ↓
┌─────────────┐   ┌─────────────┐
│ 商品別集計   │   │ カテゴリ別集計 │
│ (並列実行)   │   │ (並列実行)   │
└─────┬───────┘   └─────┬───────┘
      │                 │
      └─────────┬───────┘
                ↓
        ┌─────────────┐
        │ 統合レポート  │
        └─────────────┘
```

**並列実行の表現:**

1. 矢印を分岐させる（フォーク）
2. 各並列タスクに「(並列実行)」と記載
3. 矢印を結合させる（ジョイン）

### 8. スケジュール図の作成

#### バッチ実行タイミングの可視化

**タイムライン形式:**

```
時刻  0:00    2:00    4:00    6:00    8:00
      |──────|──────|──────|──────|
                ↓             ↓
           日次売上集計   日次在庫チェック
           (30分)        (15分)

                          ↓
                     週次レポート
                     (毎月曜 6:00)
                     (60分)
```

**Draw.ioでの作成:**

1. 「General」から「Rectangle」で時間軸を作成
2. バッチをRectangleで配置
3. 開始時刻と実行時間を記載

### 9. BPMN記法でのバッチ設計

#### BPMN 2.0でのバッチプロセス表現

```
○ → [データ抽出] → <成功？> → [データ変換] → [データ集計] → [レポート生成] → ◉
                     ↓ No
                  [エラーログ] → ◉
```

**BPMN要素:**

| 要素 | 記号 | 説明 |
|------|------|------|
| 開始イベント | ○ | バッチ開始 |
| タスク | [   ] | 処理 |
| ゲートウェイ | <> | 条件分岐 |
| 終了イベント | ◉ | バッチ終了 |

**Draw.ioでのBPMN図作成:**

1. 「BPMN」ライブラリを有効化
2. 「Start Event」、「Task」、「Gateway」、「End Event」を使用

### 10. サブバッチの呼び出し

#### メインバッチとサブバッチの関係

```
┌──────────────┐
│ メインバッチ   │
│ 月次集計      │
└───────┬──────┘
        ↓
┌──────────────┐
│ サブバッチ呼出 │
│ 商品別集計    │
└───────┬──────┘
        ↓
┌──────────────┐
│ サブバッチ呼出 │
│ 顧客別集計    │
└───────┬──────┘
        ↓
┌──────────────┐
│ 統合処理      │
└──────────────┘
```

**サブバッチの表現:**

1. 角丸四角形（Rounded Rectangle）を使用
2. ラベル: "サブバッチ: 商品別集計"
3. 破線の枠で囲む

### 11. バッチ設計書への統合

#### バッチ設計書の構成

**1. バッチ処理フロー図**

Draw.ioで作成したフロー図をPNG/PDFでエクスポートして添付

**2. ジョブネットワーク図**

複数バッチの依存関係図を添付

**3. バッチ仕様表**

| バッチID | バッチ名 | 実行タイミング | 想定実行時間 | 依存バッチ |
|---------|---------|-------------|------------|----------|
| BTH001 | 日次売上集計 | 毎日2:00 | 30分 | なし |
| BTH002 | 月次売上集計 | 月初3:00 | 60分 | BTH001（30日分） |

**4. タスク一覧**

各バッチのタスク（処理ステップ）を詳細化

**5. エラーハンドリング仕様**

エラーハンドリングフロー図を添付

### 12. レイアウトのベストプラクティス

#### 読みやすい配置

**上から下へのフロー:**

```
    [開始]
      ↓
    [処理A]
      ↓
    [処理B]
      ↓
    [終了]
```

**左から右へのフロー（長いバッチ）:**

```
[開始] → [処理A] → [処理B] → [処理C] → [終了]
```

**色分け:**

- **正常フロー**: 黒矢印
- **エラーフロー**: 赤矢印
- **リトライ**: 黄矢印
- **データストア**: 青色背景
- **外部システム**: 緑色背景

### 13. アイコンとラベルの追加

#### 処理時間の表記

各処理ボックスに想定実行時間を追加:

```
┌─────────────┐
│ データ抽出   │
│ (5分)       │
└─────────────┘
```

#### リトライ回数の表記

```
┌─────────────┐
│ API呼び出し  │
│ (リトライ3回) │
└─────────────┘
```

### 14. エクスポートとバージョン管理

#### PNG/PDF/SVGエクスポート

1. File → Export as → 形式を選択
2. **PNG**: 設計書添付用（300dpi推奨）
3. **PDF**: プレゼンテーション用
4. **SVG**: 拡大縮小可能なベクター形式

#### Git管理

```bash
git add batch_design_daily_sales.drawio
git commit -m "Add daily sales batch flow diagram"
git push
```

### 15. テンプレートの活用

#### バッチフローテンプレート

**標準テンプレート:**

1. 開始（スケジュール明記）
2. データ入力（ファイル/DB）
3. データ抽出・変換・集計
4. データ出力（ファイル/DB）
5. 通知（成功/失敗）
6. 終了

このテンプレートをベースに個別バッチを設計

### 16. レビューポイント

#### バッチフロー図のレビュー項目

- [ ] 開始・終了が明確か
- [ ] すべての処理に想定実行時間が記載されているか
- [ ] エラーハンドリングフローが含まれているか
- [ ] リトライ回数・間隔が明記されているか
- [ ] データの入出力元（ファイル/DB）が明確か
- [ ] 並列処理の同期ポイントが明確か
- [ ] スケジュール（実行タイミング）が記載されているか

## 公式ドキュメント

- **公式サイト**: [diagrams.net](https://www.diagrams.net/)
- **フローチャートガイド**: [Flowchart Shapes](https://www.drawio.com/blog/flowcharts)
- **BPMNガイド**: [BPMN Diagrams](https://www.drawio.com/blog/bpmn-2-0)

## 学習リソース

- **フローチャート作成ガイド**: [Flowchart Tutorial](https://www.youtube.com/results?search_query=drawio+flowchart)
- **BPMN 2.0チュートリアル**: [BPMN Tutorial](https://www.bpmn.org/)

## 関連リンク

- [Apache Airflow](https://airflow.apache.org/)（バッチワークフローツール）
- [Lucidchart](https://www.lucidchart.com/)（商用フローチャートツール）
- [BPMN.io](https://bpmn.io/)（BPMNモデリングツール）

## 関連ドキュメント

このツールは他の開発工程でも使用されます：

- [要件定義/業務分析でのDraw.io](../../../開発工程_2_要件定義/2_業務分析/Draw.io/Draw.io.md) - BPMNプロセス図作成
- [要件定義/ユースケース分析でのDraw.io](../../../開発工程_2_要件定義/3_ユースケース分析（機能要件定義）/Draw.io/Draw.io.md) - ユースケース図作成
- [要件定義/システム方針検討でのDraw.io](../../../開発工程_2_要件定義/10_システム方針検討（機能要件定義）/Draw.io/Draw.io.md) - システム構成図作成
- [基本設計（アプリケーション）/画面設計でのDraw.io](../2_画面設計/Draw.io/Draw.io.md) - ワイヤーフレーム、画面遷移図
- [基本設計（アプリケーション）/データベース論理設計でのDraw.io](../5_データベース論理設計/Draw.io/Draw.io.md) - ER図、テーブル関連図
- [基本設計（インフラ）/ネットワーク構成図でのDraw.io](../../../開発工程_4_基本設計_インフラ/1_ネットワーク構成図/Draw.io/Draw.io.md) - ネットワーク構成図、VLAN設計

全ツールの一覧については[ツール索引](../../../ツール索引.md)を参照してください。
